---
image: docker:18.09

variables:
# https://docs.gitlab.com/ce/ci/variables/README.html
  APP_VERSION: $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHA
  REGISTRY_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_NODE_IMAGE: node:10.15-jessie
  DOCKER_COMPOSE_VERSION: 1.19.0
  DOCKER_HOST: tcp://localhost:2375

stages:
- info
- "build and push base image"
- "build and push tremplin images"

info:
  stage: info
  script:
    - docker --version

.build:
  services:
    - docker:dind
  before_script:
    - docker login  $CI_REGISTRY -u gitlab-ci-token -p $CI_JOB_TOKEN
    - apk update && apk add --no-cache bash py-pip openssl
    - pip install docker-compose==${DOCKER_COMPOSE_VERSION}
  after_script:
    - docker logout

build-base:
  extends: .build
  stage: "build and push base image"
  script:
    - docker build -t ${REGISTRY_IMAGE}/base:${APP_VERSION} .
    - docker push ${REGISTRY_IMAGE}/base:${APP_VERSION}

build-tremplin-api:
  extends: .build
  stage: "build and push tremplin images"
  script:
     - docker build -t ${REGISTRY_IMAGE}/api:latest -t ${REGISTRY_IMAGE}/api:${APP_VERSION} --build-arg BASE_IMAGE=socialgouv/tremplin:master packages/api
     - docker push ${REGISTRY_IMAGE}/api:${APP_VERSION}

build-tremplin-app:
  extends: .build
  stage: "build and push tremplin images"
  script:
     - docker build -t ${REGISTRY_IMAGE}/app:latest -t ${REGISTRY_IMAGE}/app:${APP_VERSION} --build-arg BASE_IMAGE=socialgouv/tremplin:master packages/app
     - docker push ${REGISTRY_IMAGE}/app:${APP_VERSION}


